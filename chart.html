<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>自動チャート監視システム</title>
  <script src="https://docs.opencv.org/4.x/opencv.js" async></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <h2>チャート監視中</h2>
  <iframe id="chartFrame" src="https://fx.minkabu.jp/pair/USDJPY/chart" width="360" height="300"></iframe>
  <canvas id="chartCanvas" style="display:none;"></canvas>

  <script>
    const WEBHOOK_URL = "https://hooks.slack.com/services/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";

    function compareImages(mat1, mat2) {
      const result = new cv.Mat();
      cv.absdiff(mat1, mat2, result);
      const gray = new cv.Mat();
      cv.cvtColor(result, gray, cv.COLOR_RGBA2GRAY);
      const nonZero = cv.countNonZero(gray);
      const totalPixels = gray.rows * gray.cols;
      const similarity = ((totalPixels - nonZero) / totalPixels) * 100;
      result.delete();
      gray.delete();
      return similarity;
    }

    async function captureAndCompare() {
      const iframe = document.getElementById('chartFrame');
      const canvas = document.getElementById('chartCanvas');
      const context = canvas.getContext('2d');

      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const iframeBody = iframeDoc.body;

        const capturedCanvas = await html2canvas(iframeBody);
        canvas.width = capturedCanvas.width;
        canvas.height = capturedCanvas.height;
        context.drawImage(capturedCanvas, 0, 0);

        const capturedMat = cv.imread(canvas);
        const dummyPattern = cv.imread(canvas); // デモ用（本番では pattern画像に差し替え）

        const similarity = compareImages(capturedMat, dummyPattern);
        console.log(`類似度: ${similarity.toFixed(2)}%`);

        if (similarity > 90) {
          sendSlack(`検出通知: 類似度 ${similarity.toFixed(2)}%`);
        }

        capturedMat.delete();
        dummyPattern.delete();
      } catch (error) {
        console.error("キャプチャ処理エラー:", error);
      }
    }

    function sendSlack(message) {
      fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: message })
      }).then(res => {
        if (!res.ok) console.error("Slack送信失敗");
      }).catch(err => {
        console.error("Slackエラー:", err);
      });
    }

    window.addEventListener('load', () => {
      const checkReady = setInterval(() => {
        if (cv && cv.imread) {
          clearInterval(checkReady);
          setInterval(captureAndCompare, 5000);
        }
      }, 500);
    });
  </script>
</body>
</html>
